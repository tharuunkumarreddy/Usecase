name: Generate_Triton_Config
description: Generates Triton Inference Server config.pbtxt for RuptureNet LSTM. Based on MPQE config structure with proper Triton format.
inputs:
  - name: processed_data
    type: Dataset
    description: "Preprocessed data to extract dimensions"
  - name: model_name
    type: String
    default: "rupturenet_lstm"
    description: "Model name for Triton"
  - name: max_batch_size
    type: Integer
    default: "32"
    description: "Maximum batch size"
outputs:
  - name: config_file
    type: String
    description: "Generated config.pbtxt file"
implementation:
  container:
    image: python:3.9
    command:
      - sh
      - -c
      - |
        pip3 install --no-cache-dir numpy
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import argparse
        import os
        import pickle
        
        parser = argparse.ArgumentParser()
        parser.add_argument('--processed_data', required=True)
        parser.add_argument('--model_name', default='rupturenet_lstm')
        parser.add_argument('--max_batch_size', type=int, default=32)
        parser.add_argument('--config_file', required=True)
        args = parser.parse_args()
        
        print("="*80)
        print("TRITON CONFIG GENERATOR")
        print("="*80)
        
        data_path = os.path.join(args.processed_data, 'rupturenet_processed_data.pkl')
        print("\\nLoading data from:", data_path)
        
        with open(data_path, 'rb') as f:
            data = pickle.load(f)
        
        input_dim = len(data['feature_names'])
        latent_dim = 32
        
        print("\\nConfiguration:")
        print("  Model name:", args.model_name)
        print("  Input dimension:", input_dim)
        print("  Latent dimension:", latent_dim)
        print("  Max batch size:", args.max_batch_size)
        
        config_lines = []
        config_lines.append('name: "{0}"'.format(args.model_name))
        config_lines.append('backend: "onnxruntime"')
        config_lines.append('max_batch_size: {0}'.format(args.max_batch_size))
        config_lines.append('input [')
        config_lines.append('  {')
        config_lines.append('    name: "input"')
        config_lines.append('    data_type: TYPE_FP32')
        config_lines.append('    dims: [-1, {0}]'.format(input_dim))
        config_lines.append('  }')
        config_lines.append(']')
        config_lines.append('output [')
        config_lines.append('  {')
        config_lines.append('    name: "reconstruction"')
        config_lines.append('    data_type: TYPE_FP32')
        config_lines.append('    dims: [-1, {0}]'.format(input_dim))
        config_lines.append('  },')
        config_lines.append('  {')
        config_lines.append('    name: "latent"')
        config_lines.append('    data_type: TYPE_FP32')
        config_lines.append('    dims: [{0}]'.format(latent_dim))
        config_lines.append('  }')
        config_lines.append(']')
        config_lines.append('instance_group [')
        config_lines.append('  {')
        config_lines.append('    count: 1')
        config_lines.append('    kind: KIND_CPU')
        config_lines.append('  }')
        config_lines.append(']')
        config_lines.append('dynamic_batching {')
        config_lines.append('  preferred_batch_size: [4, 8, 16, 32]')
        config_lines.append('  max_queue_delay_microseconds: 100')
        config_lines.append('}')
        config_lines.append('version_policy {')
        config_lines.append('  latest {')
        config_lines.append('    num_versions: 1')
        config_lines.append('  }')
        config_lines.append('}')
        
        config_content = '\\n'.join(config_lines)
        
        output_dir = os.path.dirname(args.config_file)
        if output_dir:
            os.makedirs(output_dir, exist_ok=True)
        
        with open(args.config_file, 'w') as f:
            f.write(config_content)
        
        print("\\nGenerated config.pbtxt at:", args.config_file)
        print("File size:", os.path.getsize(args.config_file), "bytes")
        
        if os.path.exists(args.config_file):
            print("\\nVerification: OK")
            print("\\nConfig content:")
            print("-" * 40)
            with open(args.config_file, 'r') as f:
                print(f.read())
            print("-" * 40)
        else:
            raise Exception("Failed to create config file")
        
        print("\\n" + "="*80)
        print("COMPLETE")
        print("="*80)
        
    args:
      - --processed_data
      - {inputPath: processed_data}
      - --model_name
      - {inputValue: model_name}
      - --max_batch_size
      - {inputValue: max_batch_size}
      - --config_file
      - {outputPath: config_file}
