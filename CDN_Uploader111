name: CDN Uploader New - Enhanced
description: Uploads a specific file from a directory to CDN. Can target files by name pattern.
inputs:
  - {name: file_to_upload, description: "Path to the file/directory to upload"}
  - {name: bearer_token, type: string, description: "Bearer token for authentication"}
  - {name: target_filename, type: String, description: "Specific filename to upload from directory"}
outputs:
  - {name: cdn_url_out, type: String, description: "CDN URL where the uploaded file is accessible"}
implementation:
  container:
    image: python:3.9-slim
    command:
      - sh
      - -c
      - |
        apt-get update && apt-get install -y curl
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import argparse
        import subprocess
        import json
        import os

        parser = argparse.ArgumentParser(description="Upload specific file to CDN.")
        parser.add_argument('--file_to_upload', type=str, required=True)
        parser.add_argument('--bearer_token', type=str, required=True)
        parser.add_argument('--target_filename', type=str, default='rupturenet_processed_data.pkl')
        parser.add_argument('--cdn_url_out', type=str, required=True)
        args = parser.parse_args()

        bearer_token = args.bearer_token
        upload_url = "https://igs.gov-cloud.ai/mobius-content-service/v1.0/content/upload?filePath=MPQE1&contentTags=test"

        def upload_file_to_cdn(file_path, target_filename, output_url_path):
            actual_file_path = file_path
            
            if os.path.isdir(file_path):
                # Look for specific file by name
                target_path = os.path.join(file_path, target_filename)
                
                if os.path.exists(target_path):
                    actual_file_path = target_path
                    print(f"Found target file: {target_filename}")
                else:
                    # Fallback: list all files and find by pattern
                    all_files = [f for f in os.listdir(file_path) 
                                if os.path.isfile(os.path.join(file_path, f))]
                    
                    # Try to find file containing target pattern
                    matching_files = [f for f in all_files if target_filename in f]
                    
                    if matching_files:
                        actual_file_path = os.path.join(file_path, matching_files[0])
                        print(f"Found matching file: {matching_files[0]}")
                    elif all_files:
                        # Last resort: use largest file (likely the data file)
                        files_with_sizes = [(f, os.path.getsize(os.path.join(file_path, f))) 
                                          for f in all_files]
                        largest_file = max(files_with_sizes, key=lambda x: x[1])[0]
                        actual_file_path = os.path.join(file_path, largest_file)
                        print(f"Using largest file: {largest_file}")
                    else:
                        raise FileNotFoundError(f"No files found in directory: {file_path}")
            
            if not os.path.exists(actual_file_path):
                raise FileNotFoundError(f"File not found: {actual_file_path}")
            
            file_size = os.path.getsize(actual_file_path)
            if file_size == 0:
                raise ValueError("File is empty")
            
            print(f"Uploading file: {actual_file_path}")
            print(f"File size: {file_size:,} bytes ({file_size/1024/1024:.2f} MB)")
            
            curl_command = [
                "curl",
                "--location", upload_url,
                "--header", f"Authorization: Bearer {bearer_token}",
                "--form", f"file=@{actual_file_path}",
                "--fail",
                "--show-error"
            ]
            
            print(f"Executing upload...")
            
            try:
                process = subprocess.run(
                    curl_command,
                    capture_output=True,
                    check=True
                )
                
                response_text = process.stdout.decode('utf-8')
                print(f"Upload successful!")
                
                response_json = json.loads(response_text)
                relative_cdn_url = response_json.get("cdnUrl")
                
                if not relative_cdn_url:
                    raise ValueError("CDN response missing 'cdnUrl' field")
                
                full_cdn_url = f"https://cdn-new.gov-cloud.ai{relative_cdn_url}"
                print(f"File available at: {full_cdn_url}")
                
                output_dir = os.path.dirname(output_url_path)
                if output_dir:
                    os.makedirs(output_dir, exist_ok=True)
                
                with open(output_url_path, "w") as f:
                    f.write(full_cdn_url)
                
                print(f"CDN URL saved to: {output_url_path}")
                return full_cdn_url
                
            except subprocess.CalledProcessError as e:
                print("Upload failed!")
                print(f"Exit code: {e.returncode}")
                print(f"Error output: {e.stderr.decode('utf-8')}")
                raise
            except json.JSONDecodeError as e:
                print("Failed to parse server response as JSON")
                print(f"Response was: {process.stdout.decode('utf-8')}")
                raise
            except Exception as e:
                print(f"Unexpected error: {e}")
                raise

        try:
            cdn_url = upload_file_to_cdn(args.file_to_upload, args.target_filename, args.cdn_url_out)
            print("SUCCESS!")
            print(f"Your file is now available at: {cdn_url}")
            
        except Exception as e:
            print("UPLOAD FAILED!")
            print(f"Error: {e}")
            raise

    args:
      - --file_to_upload
      - {inputPath: file_to_upload}
      - --bearer_token
      - {inputValue: bearer_token}
      - --target_filename
      - {inputValue: target_filename}
      - --cdn_url_out
      - {outputPath: cdn_url_out}
