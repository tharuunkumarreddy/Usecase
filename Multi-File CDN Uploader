name: Multi-File CDN Uploader
description: Uploads multiple specified files from a directory to CDN and returns all URLs as JSON
inputs:
  - {name: files_directory, description: "Path to directory containing files to upload"}
  - {name: bearer_token, type: string, description: "Bearer token for authentication"}
  - {name: files_to_upload, type: String, description: "Comma-separated list of filenames to upload (e.g., 'file1.pkl,file2.pth,file3.json')"}
outputs:
  - {name: cdn_urls_json, type: String, description: "JSON file containing mapping of filename to CDN URL"}
implementation:
  container:
    image: python:3.9-slim
    command:
      - sh
      - -c
      - |
        apt-get update && apt-get install -y curl
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import argparse
        import subprocess
        import json
        import os

        parser = argparse.ArgumentParser(description="Upload multiple files to CDN.")
        parser.add_argument('--files_directory', type=str, required=True)
        parser.add_argument('--bearer_token', type=str, required=True)
        parser.add_argument('--files_to_upload', type=str, required=True)
        parser.add_argument('--cdn_urls_json', type=str, required=True)
        args = parser.parse_args()

        bearer_token = args.bearer_token
        upload_url = "https://igs.gov-cloud.ai/mobius-content-service/v1.0/content/upload?filePath=MPQE1&contentTags=rupturenet"

        def upload_single_file(file_path):
            """Upload a single file and return CDN URL"""
            if not os.path.exists(file_path):
                print(f"‚ö†Ô∏è  File not found: {file_path}")
                return None
            
            file_size = os.path.getsize(file_path)
            if file_size == 0:
                print(f"‚ö†Ô∏è  File is empty: {file_path}")
                return None
            
            filename = os.path.basename(file_path)
            print(f"\nüì§ Uploading: {filename}")
            print(f"   Size: {file_size:,} bytes ({file_size/1024/1024:.2f} MB)")
            
            curl_command = [
                "curl",
                "--location", upload_url,
                "--header", f"Authorization: Bearer {bearer_token}",
                "--form", f"file=@{file_path}",
                "--fail",
                "--show-error"
            ]
            
            try:
                process = subprocess.run(
                    curl_command,
                    capture_output=True,
                    check=True,
                    timeout=300  # 5 minute timeout
                )
                
                response_text = process.stdout.decode('utf-8')
                response_json = json.loads(response_text)
                relative_cdn_url = response_json.get("cdnUrl")
                
                if not relative_cdn_url:
                    print(f"   ‚ùå Missing 'cdnUrl' in response")
                    return None
                
                full_cdn_url = f"https://cdn-new.gov-cloud.ai{relative_cdn_url}"
                print(f"   ‚úÖ Uploaded successfully!")
                print(f"   üîó URL: {full_cdn_url}")
                return full_cdn_url
                
            except subprocess.TimeoutExpired:
                print(f"   ‚ùå Upload timeout (>5 minutes)")
                return None
            except subprocess.CalledProcessError as e:
                print(f"   ‚ùå Upload failed!")
                print(f"   Error: {e.stderr.decode('utf-8')}")
                return None
            except json.JSONDecodeError:
                print(f"   ‚ùå Invalid JSON response")
                return None
            except Exception as e:
                print(f"   ‚ùå Unexpected error: {e}")
                return None

        def main():
            print("="*80)
            print("MULTI-FILE CDN UPLOADER")
            print("="*80)
            
            # Parse files list
            files_list = [f.strip() for f in args.files_to_upload.split(',')]
            print(f"\nüìã Files to upload: {len(files_list)}")
            for f in files_list:
                print(f"   - {f}")
            
            # Upload each file
            cdn_urls = {}
            successful_uploads = 0
            failed_uploads = 0
            
            for filename in files_list:
                file_path = os.path.join(args.files_directory, filename)
                cdn_url = upload_single_file(file_path)
                
                if cdn_url:
                    cdn_urls[filename] = cdn_url
                    successful_uploads += 1
                else:
                    cdn_urls[filename] = None
                    failed_uploads += 1
            
            # Save results
            output_dir = os.path.dirname(args.cdn_urls_json)
            if output_dir:
                os.makedirs(output_dir, exist_ok=True)
            
            results = {
                "files": cdn_urls,
                "summary": {
                    "total_files": len(files_list),
                    "successful": successful_uploads,
                    "failed": failed_uploads
                }
            }
            
            with open(args.cdn_urls_json, "w") as f:
                json.dump(results, f, indent=2)
            
            print(f"\n{'='*80}")
            print("UPLOAD SUMMARY")
            print(f"{'='*80}")
            print(f"‚úÖ Successful: {successful_uploads}/{len(files_list)}")
            print(f"‚ùå Failed: {failed_uploads}/{len(files_list)}")
            print(f"\nüíæ Results saved to: {args.cdn_urls_json}")
            
            # Print all URLs
            if successful_uploads > 0:
                print(f"\n{'='*80}")
                print("CDN URLS")
                print(f"{'='*80}")
                for filename, url in cdn_urls.items():
                    if url:
                        print(f"\n{filename}:")
                        print(f"  {url}")
            
            if failed_uploads > 0:
                print(f"\n‚ö†Ô∏è  WARNING: {failed_uploads} file(s) failed to upload")
                raise Exception(f"{failed_uploads} uploads failed")
            
            print(f"\n{'='*80}")
            print("ALL UPLOADS COMPLETE!")
            print(f"{'='*80}")

        if __name__ == "__main__":
            main()

    args:
      - --files_directory
      - {inputPath: files_directory}
      - --bearer_token
      - {inputValue: bearer_token}
      - --files_to_upload
      - {inputValue: files_to_upload}
      - --cdn_urls_json
      - {outputPath: cdn_urls_json}
